<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenoPay API Test Form</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .response {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }

        .error {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .success {
            border-left-color: #4CAF50;
            background: #e8f5e8;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-pending { background: #ff9800; }
        .status-processing { background: #2196F3; }
        .status-completed { background: #4CAF50; }
        .status-failed { background: #f44336; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ ZenoPay API Test Form</h1>
            <p>Test your ZenoPay payment integration with this interactive form</p>
        </div>

        <div class="content">
            <!-- Configuration Section -->
            <div class="section">
                <h2>‚öôÔ∏è Configuration</h2>
                <div class="grid">
                    <div class="form-group">
                        <label for="baseUrl">Base URL:</label>
                        <input type="text" id="baseUrl" value="http://localhost:8000" placeholder="http://localhost:8000">
                    </div>
                    <div class="form-group">
                        <label for="apiKey">ZenoPay API Key:</label>
                        <input type="text" id="apiKey" placeholder="Your ZenoPay API Key">
                    </div>
                </div>
            </div>

            <!-- Authentication Section -->
            <div class="section">
                <h2>üîê Authentication</h2>
                <div class="grid">
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="password" id="password" placeholder="Your password">
                    </div>
                </div>
                <button onclick="login()">Login</button>
                <button onclick="logout()">Logout</button>
                <div id="authResponse" class="response hidden"></div>
            </div>

            <!-- SMS Packages Section -->
            <div class="section">
                <h2>üì¶ SMS Packages</h2>
                <button onclick="getPackages()">Get SMS Packages</button>
                <div id="packagesResponse" class="response hidden"></div>
            </div>

            <!-- SMS Balance Section -->
            <div class="section">
                <h2>üí∞ SMS Balance</h2>
                <button onclick="getBalance()">Get Current Balance</button>
                <div id="balanceResponse" class="response hidden"></div>
            </div>

            <!-- Payment Initiation Section -->
            <div class="section">
                <h2>üí≥ Initiate Payment</h2>
                <div class="grid">
                    <div class="form-group">
                        <label for="packageId">Package ID:</label>
                        <input type="text" id="packageId" placeholder="Select a package from above">
                    </div>
                    <div class="form-group">
                        <label for="buyerEmail">Buyer Email:</label>
                        <input type="email" id="buyerEmail" placeholder="buyer@example.com">
                    </div>
                    <div class="form-group">
                        <label for="buyerName">Buyer Name:</label>
                        <input type="text" id="buyerName" placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label for="buyerPhone">Buyer Phone:</label>
                        <input type="text" id="buyerPhone" placeholder="0744963858">
                    </div>
                </div>
                <button onclick="initiatePayment()">Initiate Payment</button>
                <div id="paymentResponse" class="response hidden"></div>
            </div>

            <!-- Payment Status Section -->
            <div class="section">
                <h2>üìä Payment Status & Progress</h2>
                <div class="grid">
                    <div class="form-group">
                        <label for="transactionId">Transaction ID:</label>
                        <input type="text" id="transactionId" placeholder="Will be filled automatically">
                    </div>
                </div>
                <button onclick="checkStatus()">Check Status</button>
                <button onclick="getProgress()">Get Progress</button>
                <button onclick="startStatusPolling()">Start Auto Polling</button>
                <button onclick="stopStatusPolling()">Stop Auto Polling</button>
                
                <div id="statusResponse" class="response hidden"></div>
                <div id="progressResponse" class="response hidden"></div>
                
                <!-- Progress Bar -->
                <div id="progressBar" class="progress-bar hidden">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
            </div>

            <!-- Webhook Simulation Section -->
            <div class="section">
                <h2>üîî Simulate Webhook</h2>
                <div class="grid">
                    <div class="form-group">
                        <label for="zenopayOrderId">ZenoPay Order ID:</label>
                        <input type="text" id="zenopayOrderId" placeholder="Will be filled automatically">
                    </div>
                    <div class="form-group">
                        <label for="paymentStatus">Payment Status:</label>
                        <select id="paymentStatus">
                            <option value="COMPLETED">COMPLETED</option>
                            <option value="FAILED">FAILED</option>
                            <option value="PENDING">PENDING</option>
                        </select>
                    </div>
                </div>
                <button onclick="simulateWebhook()">Simulate Webhook</button>
                <div id="webhookResponse" class="response hidden"></div>
            </div>

            <!-- Transaction History Section -->
            <div class="section">
                <h2>üìã Transaction History</h2>
                <button onclick="getTransactions()">Get All Transactions</button>
                <div id="transactionsResponse" class="response hidden"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let authToken = null;
        let currentTransactionId = null;
        let currentZenopayOrderId = null;
        let statusPollingInterval = null;

        // Configuration
        const config = {
            baseUrl: 'http://localhost:8000',
            apiKey: ''
        };

        // Utility functions
        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.classList.remove('hidden');
            element.classList.remove('error', 'success');
            
            if (isError) {
                element.classList.add('error');
            } else {
                element.classList.add('success');
            }
            
            element.textContent = JSON.stringify(data, null, 2);
        }

        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.classList.remove('hidden');
            element.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
        }

        function updateConfig() {
            config.baseUrl = document.getElementById('baseUrl').value;
            config.apiKey = document.getElementById('apiKey').value;
        }

        // API functions
        async function makeRequest(url, options = {}) {
            updateConfig();
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                }
            };

            const response = await fetch(`${config.baseUrl}${url}`, {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            });

            const data = await response.json();
            
            // Debug logging
            console.log('API Response:', { url, status: response.status, data });
            
            if (!response.ok) {
                throw new Error(data.detail || data.message || 'Request failed');
            }
            
            return data;
        }

        // Authentication
        async function login() {
            try {
                showLoading('authResponse');
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                if (!email || !password) {
                    throw new Error('Please enter email and password');
                }

                const data = await makeRequest('/api/auth/login/', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                // Debug: Log the actual response
                console.log('Login response data:', data);
                console.log('Response keys:', Object.keys(data));
                console.log('Tokens object:', data.tokens);
                console.log('Direct access:', data.access);

                // Handle different response structures
                authToken = data.tokens?.access || data.access || data.token || data.access_token;
                
                console.log('Extracted token:', authToken);
                
                if (!authToken) {
                    throw new Error('No access token received in response. Response structure: ' + JSON.stringify(data, null, 2));
                }

                showResponse('authResponse', { 
                    success: true, 
                    message: 'Login successful!',
                    token: authToken.substring(0, 20) + '...',
                    fullResponse: data
                });

                // Auto-fill buyer details
                document.getElementById('buyerEmail').value = email;
                document.getElementById('buyerName').value = email.split('@')[0];

            } catch (error) {
                console.error('Login error:', error);
                showResponse('authResponse', { 
                    success: false, 
                    error: error.message,
                    details: error.toString()
                }, true);
            }
        }

        function logout() {
            authToken = null;
            showResponse('authResponse', { 
                success: true, 
                message: 'Logged out successfully!' 
            });
        }

        // SMS Packages
        async function getPackages() {
            try {
                showLoading('packagesResponse');
                
                const data = await makeRequest('/api/billing/sms/packages/');
                
                showResponse('packagesResponse', data);
                
                // Auto-fill first package ID
                if (data.results && data.results.length > 0) {
                    document.getElementById('packageId').value = data.results[0].id;
                }

            } catch (error) {
                showResponse('packagesResponse', { 
                    success: false, 
                    error: error.message 
                }, true);
            }
        }

        // SMS Balance
        async function getBalance() {
            try {
                showLoading('balanceResponse');
                
                const data = await makeRequest('/api/billing/sms/balance/');
                
                showResponse('balanceResponse', data);

            } catch (error) {
                showResponse('balanceResponse', { 
                    success: false, 
                    error: error.message 
                }, true);
            }
        }

        // Payment Initiation
        async function initiatePayment() {
            try {
                showLoading('paymentResponse');
                
                const packageId = document.getElementById('packageId').value;
                const buyerEmail = document.getElementById('buyerEmail').value;
                const buyerName = document.getElementById('buyerName').value;
                const buyerPhone = document.getElementById('buyerPhone').value;
                
                if (!packageId || !buyerEmail || !buyerName || !buyerPhone) {
                    throw new Error('Please fill in all payment details');
                }

                const data = await makeRequest('/api/billing/payments/initiate/', {
                    method: 'POST',
                    body: JSON.stringify({
                        package_id: packageId,
                        buyer_email: buyerEmail,
                        buyer_name: buyerName,
                        buyer_phone: buyerPhone
                    })
                });

                currentTransactionId = data.data.transaction_id;
                currentZenopayOrderId = data.data.order_id;
                
                document.getElementById('transactionId').value = currentTransactionId;
                document.getElementById('zenopayOrderId').value = currentZenopayOrderId;
                
                showResponse('paymentResponse', data);
                
                // Show progress bar
                document.getElementById('progressBar').classList.remove('hidden');
                updateProgress(data.data.progress);

            } catch (error) {
                showResponse('paymentResponse', { 
                    success: false, 
                    error: error.message 
                }, true);
            }
        }

        // Payment Status
        async function checkStatus() {
            try {
                const transactionId = document.getElementById('transactionId').value;
                
                if (!transactionId) {
                    throw new Error('Please enter a transaction ID');
                }

                showLoading('statusResponse');
                
                const data = await makeRequest(`/api/billing/payments/transactions/${transactionId}/status/`);
                
                showResponse('statusResponse', data);

            } catch (error) {
                showResponse('statusResponse', { 
                    success: false, 
                    error: error.message 
                }, true);
            }
        }

        // Payment Progress
        async function getProgress() {
            try {
                const transactionId = document.getElementById('transactionId').value;
                
                if (!transactionId) {
                    throw new Error('Please enter a transaction ID');
                }

                showLoading('progressResponse');
                
                const data = await makeRequest(`/api/billing/payments/transactions/${transactionId}/progress/`);
                
                showResponse('progressResponse', data);
                updateProgress(data.data);

            } catch (error) {
                showResponse('progressResponse', { 
                    success: false, 
                    error: error.message 
                }, true);
            }
        }

        // Update Progress Bar
        function updateProgress(progressData) {
            const progressFill = document.getElementById('progressFill');
            const percentage = progressData.percentage || 0;
            progressFill.style.width = `${percentage}%`;
        }

        // Auto Polling
        function startStatusPolling() {
            if (statusPollingInterval) {
                clearInterval(statusPollingInterval);
            }
            
            statusPollingInterval = setInterval(async () => {
                try {
                    await getProgress();
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 3000);
            
            showResponse('statusResponse', { 
                success: true, 
                message: 'Auto polling started (every 3 seconds)' 
            });
        }

        function stopStatusPolling() {
            if (statusPollingInterval) {
                clearInterval(statusPollingInterval);
                statusPollingInterval = null;
            }
            
            showResponse('statusResponse', { 
                success: true, 
                message: 'Auto polling stopped' 
            });
        }

        // Webhook Simulation
        async function simulateWebhook() {
            try {
                const zenopayOrderId = document.getElementById('zenopayOrderId').value;
                const paymentStatus = document.getElementById('paymentStatus').value;
                
                if (!zenopayOrderId) {
                    throw new Error('Please enter a ZenoPay Order ID');
                }

                showLoading('webhookResponse');
                
                const data = await makeRequest('/api/billing/payments/webhook/', {
                    method: 'POST',
                    body: JSON.stringify({
                        order_id: zenopayOrderId,
                        payment_status: paymentStatus,
                        reference: 'TEST' + Date.now(),
                        metadata: {
                            product: 'SMS Credits',
                            amount: '1000'
                        }
                    })
                });
                
                showResponse('webhookResponse', data);
                
                // Auto-refresh balance after successful webhook
                if (paymentStatus === 'COMPLETED') {
                    setTimeout(() => {
                        getBalance();
                    }, 1000);
                }

            } catch (error) {
                showResponse('webhookResponse', { 
                    success: false, 
                    error: error.message 
                }, true);
            }
        }

        // Transaction History
        async function getTransactions() {
            try {
                showLoading('transactionsResponse');
                
                const data = await makeRequest('/api/billing/payments/transactions/');
                
                showResponse('transactionsResponse', data);

            } catch (error) {
                showResponse('transactionsResponse', { 
                    success: false, 
                    error: error.message 
                }, true);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ZenoPay API Test Form loaded successfully!');
            
            // Auto-fill some default values
            document.getElementById('buyerPhone').value = '0744963858';
            
            // Show initial message
            showResponse('authResponse', { 
                message: 'Please login to start testing the APIs' 
            });
        });
    </script>
</body>
</html>
